{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/bag.css' %}">
{% endblock %}

{% block content %}
    <div class="plate border">
        <div>
            <h1>Your commissions:</h1>
        </div>
        <div>
            {% if bag_items %}
                <div>
                    <table>
                        <tr>
                            <th>Artist name:</th>
                            <th>Option:</th>
                            <th>Commission details:</th>
                            <th>Price:</th>
                        </tr>
                        {% for item in bag_items %}
                        <tr>
                            <td>{{ item.artist_name }}</td>
                            <td>{{ item.commission_option }}</td>
                            <td>{{ item.details }}</td>
                            <td>{{ item.price|floatformat:2 }}</td>
                            <td>
                                <button 
                                    type="button" 
                                    class="modify-button" 
                                    data-index="{{ forloop.counter0 }}" 
                                    data-artist="{{ item.artist_name }}" 
                                    data-option="{{ item.commission_option }}" 
                                    data-details="{{ item.details }}" 
                                    data-price="{{ item.price }}">
                                    Modify
                                </button>
                            </td>
                            <td>Delete</td>
                        </tr>
                        {% endfor %}
                    </table>
                    <table>
                        <tr>
                            <td>Bag total:</td>
                            <td>£{{total|floatformat:2}}</td>
                        </tr>
                        <tr>
                            <td>Delivery:</td>
                            <td>£{{delivery|floatformat:2}}</td>
                            {% if free_delivery_delta > 0 %}
                            <td>You could get a free delivery if you spend <strong>£{{ free_delivery_delta }}</strong> more!</td>
                            {% endif %}
                        </tr>
                        <tr>
                            <td>Grand total:</td>
                            <td>£{{grand_total|floatformat:2}}</td>
                        </tr>
                        <tr>
                            <td>
                                <a href="{% url 'artists' %}">Keep Shopping</a>
                                <a href="">Secure Checkout</a>
                            </td>
                        </tr>
                    </table>
                </div>
            {% else %}
                <h2>No commissions found!</h2>
                <a href="{% url 'artists' %}">Do you want to find an artist?</a>
            {% endif %}
        </div>
    </div>

    <div id="edit-popup" class="form hidden">
        <div class="edit-content">
            <h2>Modify Commission</h2>
            <form id="modify-form" action="{% url 'update_commission' %}" method="POST">
                {% csrf_token %}

                <input type="hidden" name="index" id="commission-index">
                <input type="hidden" name="artist_id" id="artist-id">

                <label for="commission-option">Option:</label>
                <select name="commission_option" id="commission-option">
                    {% for key, value in price.items %}
                    <option value="{{ key }}">{{ key }} - £{{ value }}</option>
                    {% endfor %}
                </select>

                <label for="details">Details:</label>
                <textarea name="details" id="details"></textarea>

                <label for="price">Price:</label>
                <input type="text" name="price" id="price" readonly>
                
                <button type="submit">Save Changes</button>
                <button type="button" id="cancel-modify">Cancel</button>
            </form>
        </div>
    </div>
{% endblock %}

{% block postloadjs %}

<script>

document.addEventListener("DOMContentLoaded", function () {
    const modifyButtons = document.querySelectorAll(".modify-button");
    const modal = document.getElementById("edit-popup");
    const form = document.getElementById("modify-form");
    const indexInput = document.getElementById("commission-index");
    const artistInput = document.getElementById("artist-id");
    const optionSelect = document.getElementById("commission-option");
    const detailsTextarea = document.getElementById("details");
    const priceInput = document.getElementById("price");

    modifyButtons.forEach(button => {
        button.addEventListener("click", function () {

            // Populate the form with data from the button
            indexInput.value = button.dataset.index;
            artistInput.value = button.dataset.artist;
            optionSelect.value = button.dataset.option;
            detailsTextarea.value = button.dataset.details;
            priceInput.value = button.dataset.price;

            modal.classList.remove("hidden");
            modal.style.display = "flex";
        });
    });

    document.getElementById("cancel-modify").addEventListener("click", function () {
        const modal = document.getElementById("edit-popup");
        modal.classList.add("hidden");
        modal.style.display = "none"; // Explicitly hide the modal
        console.log("Modal closed");
    });
});

</script>
{% endblock %}