{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/profile.css' %}">
{% endblock %}

{% block content %}

<div>
    <form method="POST" action="add" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="plate border form-options">
            <div class="form-options">
                <h2 class="title">New Service Creation</h2>
                <p>Create a new service to show yourself off, {{ request.user.username }}.</p>
            </div>
            <div class="form-options">
                <label for="tag-input" class="underline">Tag:</label>
                    {{ form.tag }}
                <label for="image" class="underline">Image:</label>
                    {{ form.image }}
                <h3 class="form-title">Details</h3>
                <label for="description" class="underline">Description:</label>
                    {{ form.description }}
                <label for="slots" class="underline">Available slots:</label>
                    {{ form.slots }}
            </div>
            <div class="form-options">
                <h3 class="form-title">Preferences</h3>
                <label for="dos" class="underline">Willing to do:</label>
                {{form.dos}}
                <label for="donts" class="underline">Not willing to do:</label>
                {{form.donts}}
            </div>
            <div class="form-options">
                <h3 class="form-title">Prices</h3>
                <div class="form-options padding">
                    <label for="price_keys" class="underline">Option:</label>
                    {{ form.price_keys }}
                </div>
                <div class="form-options padding">
                    <label for="price_values" class="underline">Price:</label>
                    {{ form.price_values }}
                </div>
            </div>
            <div class="form-options">
                <button type="submit">Create!</button>
            </div>
        </div>
    </form>
</div>

{% endblock %}

{% block postloadjs %}

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const tagInput = document.getElementById('tag-input');
        const tagDropdown = document.createElement('ul');
        tagDropdown.style.position = 'absolute';
        tagDropdown.style.border = '1px solid #ccc';
        tagDropdown.style.backgroundColor = '#fff';
        tagDropdown.style.listStyleType = 'none';
        tagDropdown.style.padding = '0';
        tagDropdown.style.margin = '0';
        tagDropdown.style.display = 'none';

        tagInput.parentNode.appendChild(tagDropdown);

        tagInput.addEventListener('input', async function () {
            const query = tagInput.value.toLowerCase();
            if (query) {
                const response = await fetch('/api/tags/');
                const tags = await response.json();

                const matchingTags = tags.filter(tag => 
                    tag.fields__name.toLowerCase().includes(query) || 
                    tag.fields__friendly_name.toLowerCase().includes(query)
                );

                tagDropdown.innerHTML = '';
                matchingTags.forEach(tag => {
                    const li = document.createElement('li');
                    li.textContent = tag.fields__friendly_name;
                    li.style.padding = '8px';
                    li.style.cursor = 'pointer';

                    li.addEventListener('click', function () {
                        tagInput.value = tag.fields__friendly_name;
                        tagDropdown.style.display = 'none';
                    });

                    tagDropdown.appendChild(li);
                });

                tagDropdown.style.display = 'block';
            } else {
                tagDropdown.style.display = 'none';
            }
        });

        document.addEventListener('click', function (e) {
            if (!tagDropdown.contains(e.target) && e.target !== tagInput) {
                tagDropdown.style.display = 'none';
            }
        });
    });
</script>

{% endblock %}